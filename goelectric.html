<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>mapit.space</title>

  <link rel="stylesheet" href="styles/style.css">
  <link rel="stylesheet" href="styles/sidebar.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800%7CShadows+Into+Light" rel="stylesheet" type="text/css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <!-- Calcite Bootstrap -->
  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-bootstrap.min-v0.2.css">

  <!-- Calcite Maps -->
  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-arcgis-4.x.min-v0.2.css">

  <!-- ArcGIS JS 4.0 -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">

</head>

<body class="calcite-maps calcite-nav-top">

  <!-- Navbar -->

  <nav class="navbar calcite-navbar navbar-fixed-top calcite-text-light calcite-bg-dark">
    <!-- Title -->
    <div class="calcite-title calcite-overflow-hidden">
      <img class="goelectric logo" src="imgs/go-electric-white.png" alt="logo"/>
      <span class="bytext">created by</span>
      <img class="w3-opacity-min mapit" src="imgs/mapit-space-w.png" alt="logo"/>
    </div>
    <!-- Nav -->
    <ul class="nav navbar-nav calcite-nav">
        <div class="calcite-navbar-search calcite-search-expander">
            <div id="searchWidgetDiv"></div>
        </div>
        <li><a role="button" href="index.html" aria-haspopup="true"><span class="glyphicon glyphicon-home"></span>&nbsp;Home</a></li>
        <li><a role="button" href="goelectric.html" aria-haspopup="true"><span class="glyphicon glyphicon-map-marker"></span>&nbsp;Explore</a></li>
      </li>
    </ul>
  </nav>
  <!--/.calcite-navbar -->

  <!--Side bar--> 
    <div class="sidebar">

        <ul id ="toolTab" class="nav nav-pills colouredpill">
		    <li class="active">
                <a class="pilltext"  title="Savings Calculator" href="#savings" data-toggle="tab"><span class="glyphicon glyphicon-usd iconpilltext"></span>&nbsp;Savings</a>
		    </li>
		    <li>
                <a class="pilltext"  title="Charging Stations" href="#charging" data-toggle="tab"><span class="glyphicon glyphicon-flash iconpilltext"></span>&nbsp;Charging</a>
		    </li>
		    <li>
                <a class="pilltext" title="Driving Distance"  href="#driving" data-toggle="tab"><span class="glyphicon glyphicon-road iconpilltext"></span>&nbsp;Driving</a>
		    </li>
		    <li>
                <a class="pilltext" title="Display" href="#legend" data-toggle="tab"><span class="glyphicon glyphicon-list-alt iconpilltext"></span></a>
		    </li>
		    <li>
                <a class="pilltext" title="Help" href="#help" data-toggle="tab"><span class="glyphicon glyphicon-question-sign iconpilltext"></span></a>
		    </li>
		</ul>


    <div id="toolTabContent" class="tab-content">
    <!-- SAVINGS PANEL -->
      <div class="tab-pane fade in active" id="savings">
        <div class="well redwell">
            <div class="titlewell">Savings Calculator</div>
        </div>
        <div class="well redwell">
            <div class="wellheading">Instructions</div>
            The Savings Calculator provides an approximation of your daily driving distance, savings compared to if you drove an average-consuming gas powered vehicle, and reduction in your carbon footprint.
        </div>
        <div class="well bluewell drawpanel">
            <div class="wellheading">1) Set Home and Destination Markers</div><br/>           
            <div class="drawicons">
                Set Home
                <button class="action-button glyphicon glyphicon-home" id="homeButton" type="button" title="Set Home"></button>                             
                Set Destination
                <button class="action-button glyphicon glyphicon-map-marker" id="destButton" type="button" title="Set Destination"></button>
                <br/>
                Clear Markers            
                <button class="action-button glyphicon glyphicon-trash" id="ResetBtn" type="button" title="Clear Markers"></button>        
            </div>
            <div class="wellheading">2) Set Time Span</div><br/>           
            <div class="drawicons">
                <div class="slidecontainer">
                  <p>Number of days:</p>
                  <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
                </div>
            </div>
        </div>
        <div class="well greenwell">
            <div class="subtext">Distance Driven</div>
            <span id="distanceDriven" class="totalsavingsvalue">0</span> km
        </div>   
        <div class="well greenwell">
            <div class="subtext">Fuel Savings</div>
            <span class="totalsavingsvalue">$<span id="fuelSavings">0</span></span>
        </div>
        <div class="well greenwell">
            <div class="subtext">Carbon Footprint</div>
            <span id="carbonFootprint" class="totalsavingsvalue">0</span>
            <span class="totalsavingsmeasure">tonnes CO<sub>2</sub></span>
        </div>                  
      </div>
    <!-- CHARGING STATIONS PANEL -->
      <div class="tab-pane fade" id="charging">
        <div class="well redwell">
            <div class="titlewell">Charging Stations</div>
        </div>
        <div class="well redwell">
            <div class="wellheading">Instructions</div>
            Find charging stations nearby!
            <br /> also put in time of day!!
        </div>
        <div class="well bluewell drawpanel">
            <div class="wellheading">Set Location</div><br/>           
            <div class="drawicons">
                Add Marker
                <button class="action-button glyphicon glyphicon-map-marker" id="MarkerButton" type="button" title="Set Marker"></button>              
                <button class="action-button glyphicon glyphicon-trash" id="MarkerResetBtn" type="button" title="Clear Marker"></button>        
            </div>
            <div class="setlocation">
                Search Distance (in minutes)
                <input id="distance" type="number" min="0" placeholder="e.g. 5">
            </div>
            <div class="calculate">
                <button class="btn btn-primary btn-small"> Find Charging Stations </button>
            </div>
        </div>
        <div class="well greenwell">
            <div class="subtext">Number of Charging Stations within x mins</div>
            <span class="totalsavingsvalue">4</span>
        </div>
      </div>
    <!-- DRIVING RADIUS PANEL -->
      <div class="tab-pane fade" id="driving">
        <div class="well redwell">
            <div class="titlewell">Driving Distance</div>
        </div>
        <div class="well redwell">
            <div class="wellheading">Instructions</div>
            Find out how far you can drive on one charge!
        </div>
        <div class="well bluewell drawpanel">
            <div class="wellheading">Set Location</div><br/>           
            <div class="drawicons">
                Add Marker
                <button class="action-button glyphicon glyphicon-map-marker" id="homeButton" type="button" title="Set Home"></button>              
                <button class="action-button glyphicon glyphicon-trash" id="homeResetBtn" type="button" title="Clear Home"></button>        
            </div>
            <div class="setlocation">
                Search Distance (in minutes)
                <input id="distance" type="number" min="0" placeholder="e.g. 5">
            </div>
            <div class="calculate">
                <button class="btn btn-primary btn-small"> Find Possible Routes</button>
            </div>
        </div>
        <div class="well greenwell">
            <div class="subtext">Possible Routes</div>
            <span class="totalsavingsvalue">4132132</span>
        </div>
      </div>

      <div class="tab-pane fade" id="legend">
        <div class="well redwell">
            <div class="titlewell">Display</div>
        </div>
        <div class="well redwell">
            <div class="wellheading">Change Base Map</div><br />
            <select id="selectBasemapPanel" class="form-control">
                <option value="streets" data-vector="streets-vector">Streets</option>
                <option value="satellite" data-vector="satellite" selected="">Satellite</option>
                <option value="hybrid" data-vector="hybrid">Hybrid</option>
                <option value="national-geographic" data-vector="national-geographic">National Geographic</option>
                <option value="topo" data-vector="topo-vector">Topographic</option>
                <option value="gray" data-vector="gray-vector">Gray</option>
                <option value="dark-gray" data-vector="dark-gray-vector">Dark Gray</option>
                <option value="osm" data-vector="osm">Open Street Map</option>
                <option value="dark-gray" data-vector="streets-night-vector">Streets Night</option>
                <option value="streets" data-vector="streets-navigation-vector">Streets Mobile</option>
            </select>
        </div>
        <div class="well redwell">
            <div class="wellheading">Legend</div>
            <div id="legendDiv"></div>
        </div>
      </div>


      <!-- HELP PANEL -->
      <div class="tab-pane fade" id="help">
        <div class="well redwell">
            <div class="titlewell">Help</div>
        </div>
        <div class="well redwell">
            <div class="wellheading">How to use GoElectric</div><br/>
            <p>
                The <b>Savings</b> tab shows you how much money you would save if you drove your car to work every day for a year. 
            </p>
            <p>
                The <b>Charging</b> tab shows nearby charging stations. Set a location marker and click "Find Charging Stations."
            </p>
            <p>
                The <b>Driving</b> tab shows the radial distance you can drive on one charge from a set point. Set a location marker and click "Find Possible Routes" to get started!
            </p>
            <p>
                <b>Charging Stations</b> are denoted by plugs with leaves. Click on the icons to view more information!
            </p>
            <br/>
        </div>
      </div>
    </div>
 </div>

  <!-- Map -->
  <div class="calcite-map calcite-map-absolute mappanel">    
    <div id="mapViewDiv"></div>    
  </div>
  <!-- /.calcite-map -->


  <script type="text/javascript">
    var dojoConfig = {
      packages: [{
        name: "bootstrap",
        location: "https://esri.github.io/calcite-maps/dist/vendor/dojo-bootstrap"
      },
      {
        name: "calcite-maps",
        location: "https://esri.github.io/calcite-maps/dist/js/dojo"
      }]
    };
  </script>

<script>
    $(document).ready(function(){
        $(".nav-tabs a").click(function(){
            $(this).tab('show');
        });
    });
</script>

  <!-- ArcGIS JS 4.0 -->
<script src="https://js.arcgis.com/4.6/"></script>

  <script>
      var app;

      require([
           "esri/Map",
           "esri/views/MapView",
           "esri/widgets/Search",
           "esri/widgets/Popup",
           "esri/core/watchUtils",
           "dojo/query",
           "dojo/on",
           "esri/layers/CSVLayer",
           "esri/core/urlUtils",
           "esri/layers/FeatureLayer",
           "esri/views/2d/draw/Draw",
           "esri/widgets/Sketch/SketchViewModel",
           "esri/Graphic",
           "esri/layers/GraphicsLayer",
           "esri/widgets/Legend",
           "esri/widgets/BasemapToggle",
           "esri/widgets/Locate",
           "esri/tasks/RouteTask",
           "esri/tasks/support/RouteParameters",
           "esri/tasks/support/FeatureSet",
           "esri/config",
           "esri/widgets/Directions",
           "esri/tasks/GeometryService",
           "esri/tasks/support/LengthsParameters",

      // Bootstrap
           "bootstrap/Collapse",
           "bootstrap/Dropdown",
           "bootstrap/Tab",

      // Calcite Maps
           "calcite-maps/calcitemaps-v0.2",
           "dojo/domReady!"
         ], function (
             Map,
             MapView,
             Search,
             Popup,
             watchUtils,
             query,
             on,
             CSVLayer,
             urlUtils,
             FeatureLayer,
             Draw,
             SketchViewModel,
             Graphic,
             GraphicsLayer,
             Legend,
             BasemapToggle,
             Locate,
             RouteTask,
             RouteParameters,
             FeatureSet,
             config,
             Directions,
             GeometryService,
             LengthsParameters
           ) {

             var distDriven = document.getElementById("distanceDriven");
             var fuelSavings = document.getElementById("fuelSavings");
             var cFootprint = document.getElementById("carbonFootprint");


             // Proxy the route requests to avoid prompt for log in
             urlUtils.addProxyRule({
                 urlPrefix: "route.arcgis.com",
                 proxyUrl: "/proxy/PHP/proxy.php"
             });

             // Point the URL to a valid route service
             var routeTask = new RouteTask({
                 url: "https://route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World"
             });
             var geometryService = new GeometryService({
                 url: "http://sampleserver6.arcgisonline.com/arcgis/rest/services/Utilities/Geometry/GeometryServer"
             });

             // The stops and route result will be stored in this layer
             var routeLyr = new GraphicsLayer();

             // Setup the route parameters
             var routeParams = new RouteParameters({
                 stops: new FeatureSet(),
                 outSpatialReference: { // autocasts as new SpatialReference()
                     wkid: 3857
                 }
             });
             // Define the symbology used to display the stops
             var stopSymbol = {
                 type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
                 style: "cross",
                 size: 15,
                 outline: { // autocasts as new SimpleLineSymbol()
                     width: 4
                 }
             };

             // Define the symbology used to display the route
             var routeSymbol = {
                 type: "simple-line", // autocasts as SimpleLineSymbol()
                 color: [248, 88, 87, 0.7],
                 width: 5
             };

             app = {
                 center: [-123.10043397545394, 49.25567607806475],
                 scale: 144447,
                 basemap: "streets-navigation-vector",
                 viewPadding: {
                     top: 50,
                     bottom: 0
                 },
                 uiComponents: ["zoom", "compass", "attribution"],
                 dockOptions: {
                     position: "auto",
                     // Custom docking breakpoints
                     breakpoint: {
                         width: 768,
                         height: 768
                     }
                 },
                 mapView: null,
                 activeView: null,
                 searchWidget: null,
                 screenWidth: 0
             };

             /******************************************************************
             *
             * Create the map view and ui components
             * 
             ******************************************************************/
             // GraphicsLayer to hold graphics created via sketch view model
             var tempGraphicsLayer = new GraphicsLayer(); //home
             var tempGraphicsLayer2 = new GraphicsLayer(); //dest

             // Map
             var map = new Map({
                 basemap: app.basemap,
                 layers: [tempGraphicsLayer, tempGraphicsLayer2, routeLyr]
             });
             app.mapView = new MapView({
                 container: "mapViewDiv",
                 map: map,
                 center: app.center,
                 scale: app.scale,
                 padding: app.viewPadding,
                 popup: new Popup({
                     dockOptions: app.dockOptions
                 }),
                 ui: {
                     components: app.uiComponents
                 }
             });

             app.mapView.ui.move(["zoom"], "top-left");

             // Set the active view to scene
             app.activeView = app.mapView;

             // locator widget
             var locateBtn = new Locate({
                 view: app.mapView
             });

             //Add the locate widget to the top left corner of the view
             app.mapView.ui.add(locateBtn, {
                 position: "top-left"
             });

             app.mapView.ui.move(["compass"], "top-left");

             // Create the search widget and add it to the navbar instead of view
             app.searchWidget = new Search({
                 view: app.activeView
             }, "searchWidgetDiv");

             /* charging station template & add csv layer */
             var chargingstationtemplate = { // autocasts as new PopupTemplate()
                 title: "Charging Station at {ADDRESS}",
                 content: "<p>Lot operated by {LOT_OPERATOR}</p>",
                 fieldInfos: [{
                     fieldName: "ADDRESS",
                     format: {
                         digitSeparator: true, // Use a comma separator for large numbers
                         places: 0 // Sets the number of decimal places to 0 and rounds up
                     }
                 }, {
                     fieldName: "LOT_OPERATOR",
                     format: {
                         digitSeparator: true,
                         places: 0
                     }
                 }]
             };

             var csvLayer = new CSVLayer({
                 url: "data/chargingStations.csv",
                 popupTemplate: chargingstationtemplate
             });

             csvLayer.renderer = {
                 type: "simple",
                 symbol: {
                     type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                     url: "imgs/charging-station.png",
                     width: "20px",
                     height: "20px"
                 }
             };
             map.add(csvLayer);


             /******* ADD legend & points ***********/
             app.mapView.when(function () {

                 var legend = new Legend({
                     container: "legendDiv",
                     view: app.mapView,
                     layerInfos: [{
                         layer: csvLayer,
                         title: "Charging Stations"
                     }
                     ]
                 });

                 // create a new sketch view model
                 var sketchViewModelHome = new SketchViewModel({
                     view: app.mapView,
                     layer: tempGraphicsLayer,
                     pointSymbol: { // symbol used for points
                         type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                         url: "imgs/house.png",
                         width: "20px",
                         height: "20px"
                     }
                 });

                 var sketchViewModelDest = new SketchViewModel({
                     view: app.mapView,
                     layer: tempGraphicsLayer2,
                     pointSymbol: { // symbol used for points
                         type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                         url: "imgs/map-marker.svg",
                         width: "15px",
                         height: "20px"
                     }
                 });

                 function addStop(event) {
                     // Execute the route task if 2 or more stops are input
                     routeParams.stops.features.push(event);
                     if (routeParams.stops.features.length >= 2) {
                         routeTask.solve(routeParams).then(showRoute);
                     }
                 }

                 function measureDistance(geometry) {
                     var lengthParams = new LengthsParameters();
                     console.log(geometry);
                     lengthParams.polylines = [geometry];
                     lengthParams.lengthUnit = geometryService.UNIT_METER;
                     lengthParams.calculationType = 'geodesic';
                     lengthParams.geodesic = true;
                     geometryService.lengths(lengthParams).then(outputDistance);
                 }

                 function outputDistance(result) {
                     //console.log("Displaying result:");
                     //console.log(result.lengths.toString());

                     //TODO: Update these:
                     var dist = result.lengths / 1000;
                     distDriven.innerHTML = (dist).toFixed(2).toString();
                     fuelSavings.innerHTML = (dist*500).toFixed(2).toString();
                     cFootprint.innerHTML = (dist*5).toFixed(2).toString();
                 }

                 var routeResult = [];

                 // Adds the solved route to the map as a graphic
                 function showRoute(data) {
                     routeResult = data.routeResults[0].route;
                     routeResult.symbol = routeSymbol;
                     routeLyr.add(routeResult);
                     measureDistance(routeResult.geometry);
                 }

                 var directions = new Directions({
                     view: app.mapView
                 });
                 function useDirections() {
                     app.mapView.ui.add(directions, "top-right");
                 }
                 function closeDirections() {
                     app.mapView.ui.remove(directions);
                     directions.destroy();
                 }

                 //Clears all routes
                 function clearRoutes() {
                     for (var i = routeParams.stops.features.length - 1; i >= 0; i--) {
                         routeLyr.remove(routeParams.stops.features.splice(i, 1)[0]);
                     }
                     routeResult = [];
                     routeLyr.removeAll();
                 }

                 // ************************************************************
                 // Get the completed graphic from the event and add it to view.
                 // This event fires when user presses
                 //  * "C" key to finish sketching point, polygon or polyline.
                 //  * Double-clicks to finish sketching polyline or polygon.
                 //  * Clicks to finish sketching a point geometry.
                 // ***********************************************************
                 sketchViewModelHome.on("draw-complete", function (evt) {
                     // add the graphic to the graphics layer
                     tempGraphicsLayer.add(evt.graphic);
                     home = evt.graphic;
                     addStop(evt.graphic);
                     setActiveButton();
                 });
                 sketchViewModelDest.on("draw-complete", function (evt) {
                     // add the graphic to the graphics layer
                     tempGraphicsLayer2.add(evt.graphic);
                     dest = evt.graphic;
                     addStop(evt.graphic);
                     setActiveButton();
                 });
                 // *************************************
                 // activate the sketch to create a home point
                 // *************************************
                 var drawHomeButton = document.getElementById("homeButton");
                 drawHomeButton.onclick = function () {
                     // set the sketch to create a point geometry
                     sketchViewModelHome.create("point");
                     setActiveButton(this);
                     document.getElementById("homeButton").disabled = true;
                 };

                 // *************************************
                 // activate the sketch to create a dest point
                 // *************************************
                 var drawDestButton = document.getElementById("destButton");
                 drawDestButton.onclick = function (event) {
                     // set the sketch to create a point geometry
                     sketchViewModelDest.create("point");
                     setActiveButton(this);
                     document.getElementById("destButton").disabled = true;
                 };


                 // **************
                 // reset button
                 // **************
                 document.getElementById("ResetBtn").onclick = function () {
                     tempGraphicsLayer.removeAll();
                     sketchViewModelHome.reset();
                     sketchViewModelDest.reset();
                     document.getElementById("homeButton").disabled = false;
                     document.getElementById("destButton").disabled = false;
                     tempGraphicsLayer2.removeAll();
                     setActiveButton();
                     clearRoutes();
                     distDriven.innerHTML = "0";
                     fuelSavings.innerHTML = "0";
                     cFootprint.innerHTML = "0";
                 };

                 function setActiveButton(selectedButton) {
                     // focus the view to activate keyboard shortcuts for sketching
                     app.mapView.focus();
                     //console.log(selectedButton.id);
                     var elements = document.getElementsByClassName("active");
                     for (var i = 2; i < elements.length; i++) {
                         // skip the first element because it'll remove the active class from our side panel nav
                         //console.log(elements[i].id)
                         elements[i].classList.remove("active");
                     }
                     if (selectedButton) {
                         selectedButton.classList.add("active");
                     }
                 }
             });


             /******************************************************************
             *
             * Synchronize the view, search and popup
             * 
             ******************************************************************/

             // Tab - toggle between map and scene view
             query(".calcite-navbar li a[data-toggle='tab']").on("click", function (
             e) {
                 syncTabs(e);

                 syncViews(app.mapView);
                 app.activeView = app.mapView;

                 syncSearch();
             });

             // Tabs - sync ui menus
             function syncTabs(e) {
                 query(".calcite-navbar li.active").removeClass("active");
                 query(e.target).addClass("active");
             }

             // Views - sync viewpoint and popup
             function syncViews(fromView, toView) {
                 watchUtils.whenTrueOnce(toView, "ready").then(function (result) {
                     watchUtils.whenTrueOnce(toView, "stationary").then(function (
                 result) {
                         toView.goTo(fromView.viewpoint);
                         toView.popup.reposition();
                     });
                 });
             }

             // Search - sync search location and popup
             function syncSearch() {
                 app.searchWidget.view = app.activeView;
                 if (app.searchWidget.selectedResult) {
                     app.searchWidget.search(app.searchWidget.selectedResult.name);
                     app.activeView.popup.reposition();
                 }
             }

             /******************************************************************
             *
             * Show and hide the panels and popup
             * 
             ******************************************************************/

             // Views - Listen to view size changes to show/hide panels
             app.mapView.watch("size", viewSizeChange);

             function viewSizeChange(screenSize) {
                 if (app.screenWidth !== screenSize[0]) {
                     app.screenWidth = screenSize[0];
                     setPanelVisibility();
                 }
             }

             // Popups - Listen to popup changes to show/hide panels
             app.mapView.popup.watch(["visible", "currentDockPosition"],
             setPanelVisibility);

             // Panels - Show/hide the panel when popup is docked
             function setPanelVisibility() {
                 var isMobileScreen = app.activeView.widthBreakpoint === "xsmall" ||
               app.activeView.widthBreakpoint ===
               "small",
               isDockedVisible = app.activeView.popup.visible && app.activeView.popup
               .currentDockPosition,
               isDockedBottom = app.activeView.popup.currentDockPosition && app.activeView
               .popup.currentDockPosition
               .indexOf("bottom") > -1,
               isDockedTop = app.activeView.popup.currentDockPosition && app.activeView
               .popup.currentDockPosition
               .indexOf("top") > -1;
                 // Mobile (xsmall/small)
                 if (isMobileScreen) {
                     if (isDockedVisible && isDockedBottom) {
                         query(".calcite-panels").addClass("invisible");
                     } else {
                         query(".calcite-panels").removeClass("invisible");
                     }
                 } else { // Desktop (medium+)
                     if (isDockedVisible && isDockedTop) {
                         query(".calcite-panels").addClass("invisible");
                     } else {
                         query(".calcite-panels").removeClass("invisible");
                     }
                 }
             }

             // Panels - Dock popup when panels show (desktop or mobile)
             query(".calcite-panels .panel").on("show.bs.collapse", function (e) {
                 if (app.activeView.popup.currentDockPosition || app.activeView.widthBreakpoint ===
               "xsmall") {
                     app.activeView.popup.dockEnabled = false;
                 }
             });

             // Panels - Undock popup when panels hide (mobile only)
             query(".calcite-panels .panel").on("hide.bs.collapse", function (e) {
                 if (app.activeView.widthBreakpoint === "xsmall") {
                     app.activeView.popup.dockEnabled = true;
                 }
             });

             // Popup
             query(".esri-popup__header-title").on("click", function (e) {
                 query(".esri-popup__main-container").toggleClass(
               "esri-popup-collapsed");
                 app.activeView.popup.reposition();
             } .bind(this));

             /******************************************************************
             *
             * Apply Calcite Maps CSS classes to change application on the fly
             *
             * For more information about the CSS styles or Sass build visit:
             * http://github.com/esri/calcite-maps
             * 
             ******************************************************************/

             var cssSelectorUI = ".calcite-navbar, .calcite-panels",
             cssSelectorMap = ".calcite-map";

             // Basemap events
             query("#selectBasemapPanel").on("change", function (e) {
                 app.mapView.map.basemap = e.target.options[e.target.selectedIndex]
               .dataset.vector;
             });

             // Set view padding for widgets based on navbar position
             function setViewPadding(layout) {
                 var padding, uiPadding;
                 // Top
                 if (layout === "calcite-nav-top") {
                     padding = {
                         padding: {
                             top: 50,
                             bottom: 0
                         }
                     };
                     uiPadding = {
                         padding: {
                             top: 15,
                             right: 15,
                             bottom: 30,
                             left: 15
                         }
                     };
                 } else { // Bottom
                     padding = {
                         padding: {
                             top: 0,
                             bottom: 50
                         }
                     };
                     uiPadding = {
                         padding: {
                             top: 30,
                             right: 15,
                             bottom: 15,
                             left: 15
                         }
                     };
                 }
                 app.mapView.set(padding);
                 app.mapView.ui.set(uiPadding);
                 // Reset popup
                 if (app.activeView.popup.visible && app.activeView.popup.dockEnabled) {
                     app.activeView.popup.visible = false;
                     app.activeView.popup.visible = true;
                 }
             }

         });
  </script>

</body>
</html>