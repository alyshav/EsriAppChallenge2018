<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>mapit.space</title>

  <link rel="stylesheet" href="styles/style.css">
  <link rel="stylesheet" href="styles/sidebar.css">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800%7CShadows+Into+Light" rel="stylesheet" type="text/css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <!-- Calcite Bootstrap -->
  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-bootstrap.min-v0.2.css">

  <!-- Calcite Maps -->
  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-arcgis-4.x.min-v0.2.css">

  <!-- ArcGIS JS 4.0 -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">

</head>

<body class="calcite-maps calcite-nav-top">

  <!-- Navbar -->

  <nav class="navbar calcite-navbar navbar-fixed-top calcite-text-light calcite-bg-dark">
    <!-- Title -->
    <div class="calcite-title calcite-overflow-hidden">
      <img class="logo" src="imgs/mapit-space-trans-bg-2.png" alt="logo"/>
      <span class="calcite-title-divider hidden-xs"></span>
      <img class="logo" src="imgs/mapit-space-trans-bg-2.png" alt="logo"/>
    </div>
    <!-- Nav -->
    <ul class="nav navbar-nav calcite-nav">
        <div class="calcite-navbar-search calcite-search-expander">
            <div id="searchWidgetDiv"></div>
        </div>
        <li><a role="button" href="index.html" aria-haspopup="true"><span class="glyphicon glyphicon-home"></span>&nbsp;Home</a></li>
        <li><a role="button" href="goelectric.html" aria-haspopup="true"><span class="glyphicon glyphicon-map-marker"></span>&nbsp;Explore</a></li>
      </li>
    </ul>
  </nav>
  <!--/.calcite-navbar -->

  <!--Side bar--> 
    <div class="sidebar">

        <ul id ="toolTab" class="nav nav-pills colouredpill">
		    <li class="active">
                <a class="pilltext" href="#savings" data-toggle="tab"><span class="glyphicon glyphicon-usd iconpilltext"></span>&nbsp;Savings</a>
		    </li>
		    <li>
                <a class="pilltext" href="#charging" data-toggle="tab"><span class="glyphicon glyphicon-flash iconpilltext"></span>&nbsp;Charging</a>
		    </li>
		    <li>
                <a class="pilltext" href="#driving" data-toggle="tab"><span class="glyphicon glyphicon-road iconpilltext"></span>&nbsp;Driving</a>
		    </li>
		    <li>
                <a class="pilltext" href="#help" data-toggle="tab"><span class="glyphicon glyphicon-question-sign iconpilltext"></span></a>
		    </li>
		</ul>


    <div id="toolTabContent" class="tab-content">
    <!-- SAVINGS PANEL -->
      <div class="tab-pane fade in active" id="savings">
        <div class="well redwell">
            <div class="titlewell">Savings Calculator</div>
        </div>
        <div class="well redwell">
            <div class="wellheading">Instructions</div>
            The Savings Calculator provides an approximation of your daily driving distance, savings compared to if you drove an average-consuming gas powered vehicle, and reduction in your carbon footprint.
            Set your home and workplace to get started!
        </div>
        <div class="well bluewell drawpanel">
            <div class="wellheading">Home & Work Destinations</div><br/>           
            <div class="drawicons">
                Set Home
                <button class="action-button glyphicon glyphicon-home" id="homeButton" type="button" title="Set Home"></button>              
                <button class="action-button glyphicon glyphicon-trash" id="homeResetBtn" type="button" title="Clear Home"></button>        
            </div>
            <div class="drawicons">
                Set Workplace
                <button class="action-button glyphicon glyphicon-briefcase" id="destButton" type="button" title="Set Workplace"></button>              
                <button class="action-button glyphicon glyphicon-trash" id="destResetBtn" type="button" title="Clear Workplace"></button>        
            </div>
            <div class="calculate">
                <button class="btn btn-primary btn-small">Calculate Savings </button>
            </div>
        </div>
        <div class="well greenwell">
            <div class="subtext">Distance Driven each Day</div>
            <div class="totalsavingsvalue">150 km</div>
        </div>   
        <div class="well greenwell">
            <div class="subtext">Total Savings</div>
            <span class="totalsavingsvalue">$15000</span>
        </div>
        <div class="well greenwell">
            <div class="subtext">Carbon Footprint</div>
            <span class="totalsavingsvalue">420</span>
            <span class="totalsavingsmeasure">tonnes CO<sub>2</sub></span>
        </div>                  
      </div>
    <!-- CHARGING STATIONS PANEL -->
      <div class="tab-pane fade" id="charging">
        <div class="well redwell">
            <div class="titlewell">Charging Stations</div>
        </div>
        <div class="well redwell">
            <div class="wellheading">Instructions</div>
            Find charging stations nearby!
        </div>
        <div class="well bluewell drawpanel">
            <div class="wellheading">Set Location</div><br/>           
            <div class="drawicons">
                Add Marker
                <button class="action-button glyphicon glyphicon-map-marker" id="MarkerButton" type="button" title="Set Marker"></button>              
                <button class="action-button glyphicon glyphicon-trash" id="MarkerResetBtn" type="button" title="Clear Marker"></button>        
            </div>
            <div class="setlocation">
                Search Distance (in minutes)
                <input id="distance" type="number" min="0" placeholder="e.g. 5">
            </div>
            <div class="calculate">
                <button class="btn btn-primary btn-small"> Find Charging Stations </button>
            </div>
        </div>
        <div class="well greenwell">
            <div class="subtext">Number of Charging Stations within x mins</div>
            <span class="totalsavingsvalue">4</span>
        </div>
      </div>
    <!-- DRIVING RADIUS PANEL -->
      <div class="tab-pane fade" id="driving">
        <div class="well redwell">
            <div class="titlewell">Driving Distance</div>
        </div>
        <div class="well redwell">
            <div class="wellheading">Instructions</div>
            Find out how far you can drive on one charge!
        </div>
        <div class="well bluewell drawpanel">
            <div class="wellheading">Set Location</div><br/>           
            <div class="drawicons">
                Add Marker
                <button class="action-button glyphicon glyphicon-map-marker" id="homeButton" type="button" title="Set Home"></button>              
                <button class="action-button glyphicon glyphicon-trash" id="homeResetBtn" type="button" title="Clear Home"></button>        
            </div>
            <div class="setlocation">
                Search Distance (in minutes)
                <input id="distance" type="number" min="0" placeholder="e.g. 5">
            </div>
            <div class="calculate">
                <button class="btn btn-primary btn-small"> Find Possible Routes</button>
            </div>
        </div>
        <div class="well greenwell">
            <div class="subtext">Possible Routes</div>
            <span class="totalsavingsvalue">4132132</span>
        </div>
      </div>

      <!-- HELP PANEL -->
      <div class="tab-pane fade" id="help">
        <div class="well redwell">
            <div class="titlewell">Help</div>
        </div>
        <div class="well redwell">
            <div class="wellheading">How to use GoElectric</div><br/>
            <p>
                The <b>Savings</b> tab shows you how much money you would save if you drove your car to work every day for a year. 
            </p>
            <p>
                The <b>Charging</b> tab shows nearby charging stations. Set a location marker and click "Find Charging Stations."
            </p>
            <p>
                The <b>Driving</b> tab shows the radial distance you can drive on one charge from a set point. Set a location marker and click "Find Possible Routes" to get started!
            </p>
            <p>
                <b>Charging Stations</b> are denoted by plugs with leaves. Click on the icons to view more information!
            </p>
            <br/>
        </div>
      </div>
    </div>
 </div>

  <!-- Map -->
  <div class="calcite-map calcite-map-absolute mappanel">    
    <div id="mapViewDiv"></div>    
  </div>
  <!-- /.calcite-map -->


  <script type="text/javascript">
    var dojoConfig = {
      packages: [{
        name: "bootstrap",
        location: "https://esri.github.io/calcite-maps/dist/vendor/dojo-bootstrap"
      },
      {
        name: "calcite-maps",
        location: "https://esri.github.io/calcite-maps/dist/js/dojo"
      }]
    };
  </script>

<script>
    $(document).ready(function(){
        $(".nav-tabs a").click(function(){
            $(this).tab('show');
        });
    });
</script>

  <!-- ArcGIS JS 4.0 -->
<script src="https://js.arcgis.com/4.6/"></script>

  <script>
      var app;

      require([
           "esri/Map",
           "esri/views/MapView",
           "esri/widgets/Search",
           "esri/widgets/Popup",
           "esri/core/watchUtils",
           "dojo/query",
           "dojo/on",
           "esri/layers/CSVLayer",
           "esri/core/urlUtils",
           "esri/layers/FeatureLayer",
           "esri/views/2d/draw/Draw",
           "esri/widgets/Sketch/SketchViewModel",
           "esri/Graphic",
           "esri/layers/GraphicsLayer",

      // Bootstrap
           "bootstrap/Collapse",
           "bootstrap/Dropdown",
           "bootstrap/Tab",

      // Calcite Maps
           "calcite-maps/calcitemaps-v0.2",
           "dojo/domReady!"
         ], function (
             Map,
             MapView,
             Search,
             Popup,
             watchUtils,
             query,
             on,
             CSVLayer,
             urlUtils,
             FeatureLayer,
             Draw,
             SketchViewModel,
             Graphic,
             GraphicsLayer
           ) {

             /******************************************************************
             *
             * App settings
             * 
             ******************************************************************/
             app = {
                 center: [-123.10043397545394, 49.25567607806475],
                 scale: 144447,
                 basemap: "streets-navigation-vector",
                 viewPadding: {
                     top: 50,
                     bottom: 0
                 },
                 uiComponents: ["zoom", "compass", "attribution"],
                 dockOptions: {
                     position: "auto",
                     // Custom docking breakpoints
                     breakpoint: {
                         width: 768,
                         height: 768
                     }
                 },
                 mapView: null,
                 activeView: null,
                 searchWidget: null,
                 screenWidth: 0
             };

             /******************************************************************
             *
             * Create the map view and ui components
             * 
             ******************************************************************/
             // GraphicsLayer to hold graphics created via sketch view model
             var tempGraphicsLayer = new GraphicsLayer();
             var tempGraphicsLayer2 = new GraphicsLayer();

             // Map
             var map = new Map({
                 basemap: app.basemap,
                 layers: [tempGraphicsLayer, tempGraphicsLayer2]
             });
             app.mapView = new MapView({
                 container: "mapViewDiv",
                 map: map,
                 center: app.center,
                 scale: app.scale,
                 padding: app.viewPadding,
                 popup: new Popup({
                     dockOptions: app.dockOptions
                 }),
                 ui: {
                     components: app.uiComponents
                 }
             });

             app.mapView.ui.move(["zoom", "compass"], "top-left");


             // Set the active view to scene
             app.activeView = app.mapView;

             // Create the search widget and add it to the navbar instead of view
             app.searchWidget = new Search({
                 view: app.activeView
             }, "searchWidgetDiv");




             var chargingstationtemplate = { // autocasts as new PopupTemplate()
                 title: "Charging Station at {ADDRESS}",
                 content: "<p>Lot operated by {LOT_OPERATOR}</p>",
                 fieldInfos: [{
                     fieldName: "ADDRESS",
                     format: {
                         digitSeparator: true, // Use a comma separator for large numbers
                         places: 0 // Sets the number of decimal places to 0 and rounds up
                     }
                 }, {
                     fieldName: "LOT_OPERATOR",
                     format: {
                         digitSeparator: true,
                         places: 0
                     }
                 }]
             };

             var csvLayer = new CSVLayer({
                 url: "data/chargingStations.csv",
                 popupTemplate: chargingstationtemplate
             });

             csvLayer.renderer = {
                 type: "simple",
                 symbol: {
                     type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                     url: "imgs/plug.png",
                     width: "20px",
                     height: "40px"
                 }
             };
             map.add(csvLayer);


             /******* ADD POINTS ***********/
             app.mapView.when(function () {
                 // create a new sketch view model
                 var sketchViewModelHome = new SketchViewModel({
                     view: app.mapView,
                     layer: tempGraphicsLayer,
                     pointSymbol: { // symbol used for points
                         type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                         url: "imgs/house.png",
                         width: "20px",
                         height: "20px"
                     }
                 });

                 var sketchViewModelDest = new SketchViewModel({
                     view: app.mapView,
                     layer: tempGraphicsLayer2,
                     pointSymbol: { // symbol used for points
                         type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                         url: "imgs/briefcase.svg",
                         width: "20px",
                         height: "20px"
                     }
                 });

                 // ************************************************************
                 // Get the completed graphic from the event and add it to view.
                 // This event fires when user presses
                 //  * "C" key to finish sketching point, polygon or polyline.
                 //  * Double-clicks to finish sketching polyline or polygon.
                 //  * Clicks to finish sketching a point geometry.
                 // ***********************************************************
                 sketchViewModelHome.on("draw-complete", function (evt) {
                     // add the graphic to the graphics layer
                     //console.log(evt);
                     tempGraphicsLayer.add(evt.graphic);
                     setActiveButton();
                 });
                 sketchViewModelDest.on("draw-complete", function (evt) {
                     // add the graphic to the graphics layer
                     console.log(evt);
                     tempGraphicsLayer2.add(evt.graphic);
                     setActiveButton();
                 });
                 // *************************************
                 // activate the sketch to create a home point
                 // *************************************
                 var drawHomeButton = document.getElementById("homeButton");
                 drawHomeButton.onclick = function () {
                     // set the sketch to create a point geometry
                     sketchViewModelHome.create("point");
                     setActiveButton(this);
                     document.getElementById("homeButton").disabled = true;
                 };

                 // *************************************
                 // activate the sketch to create a dest point
                 // *************************************
                 var drawDestButton = document.getElementById("destButton");
                 drawDestButton.onclick = function (event) {
                     console.log(event);
                     // set the sketch to create a point geometry
                     sketchViewModelDest.create("point");
                     setActiveButton(this);
                     document.getElementById("destButton").disabled = true;
                 };


                 // **************
                 // Home reset button
                 // **************
                 document.getElementById("homeResetBtn").onclick = function () {
                     tempGraphicsLayer.removeAll();
                     sketchViewModelHome.reset();
                     setActiveButton();
                     document.getElementById("homeButton").disabled = false;
                 };

                 // **************
                 // dest reset button
                 // **************
                 document.getElementById("destResetBtn").onclick = function () {
                     tempGraphicsLayer2.removeAll();
                     sketchViewModelDest.reset();
                     setActiveButton();
                     document.getElementById("destButton").disabled = false;
                 };

                 function setActiveButton(selectedButton) {
                     // focus the view to activate keyboard shortcuts for sketching
                     app.mapView.focus();
                     //console.log(selectedButton.id);
                     var elements = document.getElementsByClassName("active");
                     for (var i = 2; i < elements.length; i++) {
                         // skip the first element because it'll remove the active class from our side panel nav
                         //console.log(elements[i].id)
                         elements[i].classList.remove("active");
                     }
                     if (selectedButton) {
                         selectedButton.classList.add("active");
                     }
                 }
             });


             /******************************************************************
             *
             * Synchronize the view, search and popup
             * 
             ******************************************************************/

             // Tab - toggle between map and scene view
             query(".calcite-navbar li a[data-toggle='tab']").on("click", function (
             e) {
                 syncTabs(e);

                 syncViews(app.mapView);
                 app.activeView = app.mapView;

                 syncSearch();
             });

             // Tabs - sync ui menus
             function syncTabs(e) {
                 query(".calcite-navbar li.active").removeClass("active");
                 query(e.target).addClass("active");
             }

             // Views - sync viewpoint and popup
             function syncViews(fromView, toView) {
                 watchUtils.whenTrueOnce(toView, "ready").then(function (result) {
                     watchUtils.whenTrueOnce(toView, "stationary").then(function (
                 result) {
                         toView.goTo(fromView.viewpoint);
                         toView.popup.reposition();
                     });
                 });
             }

             // Search - sync search location and popup
             function syncSearch() {
                 app.searchWidget.view = app.activeView;
                 if (app.searchWidget.selectedResult) {
                     app.searchWidget.search(app.searchWidget.selectedResult.name);
                     app.activeView.popup.reposition();
                 }
             }

             /******************************************************************
             *
             * Show and hide the panels and popup
             * 
             ******************************************************************/

             // Views - Listen to view size changes to show/hide panels
             app.mapView.watch("size", viewSizeChange);

             function viewSizeChange(screenSize) {
                 if (app.screenWidth !== screenSize[0]) {
                     app.screenWidth = screenSize[0];
                     setPanelVisibility();
                 }
             }

             // Popups - Listen to popup changes to show/hide panels
             app.mapView.popup.watch(["visible", "currentDockPosition"],
             setPanelVisibility);

             // Panels - Show/hide the panel when popup is docked
             function setPanelVisibility() {
                 var isMobileScreen = app.activeView.widthBreakpoint === "xsmall" ||
               app.activeView.widthBreakpoint ===
               "small",
               isDockedVisible = app.activeView.popup.visible && app.activeView.popup
               .currentDockPosition,
               isDockedBottom = app.activeView.popup.currentDockPosition && app.activeView
               .popup.currentDockPosition
               .indexOf("bottom") > -1,
               isDockedTop = app.activeView.popup.currentDockPosition && app.activeView
               .popup.currentDockPosition
               .indexOf("top") > -1;
                 // Mobile (xsmall/small)
                 if (isMobileScreen) {
                     if (isDockedVisible && isDockedBottom) {
                         query(".calcite-panels").addClass("invisible");
                     } else {
                         query(".calcite-panels").removeClass("invisible");
                     }
                 } else { // Desktop (medium+)
                     if (isDockedVisible && isDockedTop) {
                         query(".calcite-panels").addClass("invisible");
                     } else {
                         query(".calcite-panels").removeClass("invisible");
                     }
                 }
             }

             // Panels - Dock popup when panels show (desktop or mobile)
             query(".calcite-panels .panel").on("show.bs.collapse", function (e) {
                 if (app.activeView.popup.currentDockPosition || app.activeView.widthBreakpoint ===
               "xsmall") {
                     app.activeView.popup.dockEnabled = false;
                 }
             });

             // Panels - Undock popup when panels hide (mobile only)
             query(".calcite-panels .panel").on("hide.bs.collapse", function (e) {
                 if (app.activeView.widthBreakpoint === "xsmall") {
                     app.activeView.popup.dockEnabled = true;
                 }
             });

             // Popup
             query(".esri-popup__header-title").on("click", function (e) {
                 query(".esri-popup__main-container").toggleClass(
               "esri-popup-collapsed");
                 app.activeView.popup.reposition();
             } .bind(this));

             /******************************************************************
             *
             * Apply Calcite Maps CSS classes to change application on the fly
             *
             * For more information about the CSS styles or Sass build visit:
             * http://github.com/esri/calcite-maps
             * 
             ******************************************************************/

             var cssSelectorUI = ".calcite-navbar, .calcite-panels",
             cssSelectorMap = ".calcite-map";

             // Basemap events
             query("#selectBasemapPanel").on("change", function (e) {
                 app.mapView.map.basemap = e.target.options[e.target.selectedIndex]
               .dataset.vector;
             });

             // Set view padding for widgets based on navbar position
             function setViewPadding(layout) {
                 var padding, uiPadding;
                 // Top
                 if (layout === "calcite-nav-top") {
                     padding = {
                         padding: {
                             top: 50,
                             bottom: 0
                         }
                     };
                     uiPadding = {
                         padding: {
                             top: 15,
                             right: 15,
                             bottom: 30,
                             left: 15
                         }
                     };
                 } else { // Bottom
                     padding = {
                         padding: {
                             top: 0,
                             bottom: 50
                         }
                     };
                     uiPadding = {
                         padding: {
                             top: 30,
                             right: 15,
                             bottom: 15,
                             left: 15
                         }
                     };
                 }
                 app.mapView.set(padding);
                 app.mapView.ui.set(uiPadding);
                 // Reset popup
                 if (app.activeView.popup.visible && app.activeView.popup.dockEnabled) {
                     app.activeView.popup.visible = false;
                     app.activeView.popup.visible = true;
                 }
             }

         });
  </script>

</body>
</html>